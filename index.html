<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ¥µé€Ÿæˆ°æƒ…å®¤ (Pro Max)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root { --bg:#000; --card:#1c1c1e; --text:#fff; --red:#ff453a; --green:#30d158; --yellow:#ffd60a; --blue:#0a84ff; --gray:#8e8e93; }
    body { background:var(--bg); color:var(--text); font-family:-apple-system, sans-serif; padding:15px; margin:0; overflow-x:hidden; }
    
    .dashboard-container { filter: blur(10px); transition: filter 0.5s; pointer-events: none; }
    .unlocked { filter: blur(0); pointer-events: auto; }

    /* ç‰ˆé¢é…ç½® */
    .top-section { display:grid; grid-template-columns:1fr 1.3fr; gap:12px; margin-bottom:15px; }
    .box { background:var(--card); border-radius:18px; padding:16px; display:flex; flex-direction:column; justify-content:space-between; }
    
    .big-val { font-size:32px; font-weight:600; letter-spacing:-1px; margin-top:5px; }
    .power-val { font-size:38px; font-weight:700; text-align:right; } 
    .chip-tag { font-size:11px; padding:3px 8px; border-radius:6px; width:fit-content; background:#333; color:#ccc; }
    
    .chip-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .chip-card { background:var(--card); padding:12px; border-radius:14px; display:flex; flex-direction:column; }
    .label { font-size:12px; color:var(--gray); font-weight:600; text-transform:uppercase; }
    
    .c-red { color:var(--red); } .c-green { color:var(--green); }
    .bg-red { background:rgba(255, 69, 58, 0.15); color:var(--red); } 
    .bg-green { background:rgba(48, 209, 88, 0.15); color:var(--green); }
    .alert-red { border: 1px solid var(--red) !important; box-shadow: 0 0 15px rgba(255, 69, 58, 0.2); }
    .alert-green { border: 1px solid var(--green) !important; box-shadow: 0 0 15px rgba(48, 209, 88, 0.2); }

    /* å¤šç©ºå°æˆ°æ¢ */
    .battle-box { background: var(--card); border-radius: 18px; padding: 16px; margin-bottom: 15px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
    .tug-container { height: 24px; background: #111; border-radius: 12px; position: relative; overflow: hidden; display: flex; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); margin-bottom: 5px; }
    .bull-bar { height: 100%; background: var(--red); transition: width 0.5s; }
    .bear-bar { height: 100%; background: var(--green); transition: width 0.5s; }
    .percent-text { position: absolute; width: 100%; text-align: center; top: 4px; font-size: 12px; font-weight: bold; color: rgba(255,255,255,0.8); text-shadow: 0 1px 2px #000; z-index: 5; letter-spacing: 1px; }
    .force-display { text-align: center; font-size: 28px; font-weight: 800; margin: 5px 0; letter-spacing: -0.5px; }
    .force-label { text-align: center; font-size: 12px; color: var(--gray); margin-top: -5px; }
    .army-stats { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; margin-top: 5px; padding: 0 10px; }
    .logic-text { text-align: center; font-size: 15px; font-weight: 700; color: #fff; margin-top: 5px; padding-top: 10px; border-top: 1px solid #333; }

    /* æˆ°å ´é‚Šç•Œ */
    .range-box { background: var(--card); border-radius: 18px; padding: 12px 16px; margin-bottom: 15px; display: grid; grid-template-rows: 1fr 1fr; gap: 10px; position: relative; overflow: hidden; }
    .range-box::after { content: ""; position: absolute; top: 50%; left: 16px; right: 16px; height: 1px; background: #333; }
    .range-row { display: flex; justify-content: space-between; align-items: center; }
    .range-title { font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .range-val { font-size: 20px; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .range-vol { font-size: 11px; color: #666; font-weight: normal; margin-left: 4px; }
    .range-old { font-size: 12px; color: #666; font-weight: normal; display: flex; align-items: center; }
    .arrow-icon { font-size: 10px; margin: 0 4px; color: #444; }

    /* åœ–è¡¨å€å¡Š (åŠ é«˜ä»¥å®¹ç´å…©å€‹å‡åˆ†å€åŸŸ) */
    .chart-box { background: var(--card); border-radius: 18px; padding: 10px; margin-top: 20px; margin-bottom: 30px; height: 450px; position: relative; }

    /* ç™»å…¥é®ç½© */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .login-box { text-align: center; width: 80%; max-width: 300px; }
    input[type="password"] { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #1c1c1e; color: #fff; font-size: 18px; text-align: center; margin-bottom: 15px; outline: none; }
    button { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--blue); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; }
    .error-msg { color: var(--red); font-size: 14px; margin-top: 10px; min-height: 20px; }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <div style="font-size:20px; margin-bottom:20px; color:#fff; font-weight:600;">ğŸ”’ æˆ°æƒ…å®¤ç™»å…¥</div>
      <input type="password" id="pass-input" placeholder="å¯†ç¢¼" pattern="[0-9]*" inputmode="numeric">
      <button onclick="checkPass()">é€²å…¥ç›£æ§</button>
      <div class="error-msg" id="error-msg"></div>
    </div>
  </div>

  <div class="dashboard-container" id="dashboard">
    <div class="top-section">
      <div class="box">
        <div class="label">TX å°æŒ‡æœŸ</div>
        <div id="price" class="big-val">---</div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:13px; color:#aaa; font-weight:500;">
            <div>ğŸŒ æ—¥ <span id="vwap-day" style="color:#fff; font-weight:600; margin-left:2px;">--</span></div>
            <div>ğŸŒ™ å¤œ <span id="vwap-night" style="color:#fff; font-weight:600; margin-left:2px;">--</span></div>
        </div>
        <div id="update-time" class="label" style="margin-top:8px; color:#666; font-size:10px; text-align:right;">--:--:--</div>
      </div>
      <div class="box" style="text-align:right" id="pwr-box">
        <div class="label">ğŸš€ P6 è²·æ–¹å‹•èƒ½</div>
        <div id="pwr-val" class="power-val">0%</div>
        <div id="pwr-tag" class="chip-tag" style="align-self: flex-end;">Wait</div>
      </div>
    </div>

    <div class="label" style="margin-bottom:8px">âš”ï¸ OP å¤šç©ºåŠ›é“ (å…§å¤–ç›¤å·®)</div>
    <div class="battle-box" id="battle-card">
        <div class="tug-container">
            <div id="bull-bar" class="bull-bar" style="width: 50%;"></div>
            <div id="bear-bar" class="bear-bar" style="width: 50%;"></div>
            <div id="ratio-text" class="percent-text">50% vs 50%</div>
        </div>
        <div id="net-force-val" class="force-display">-- å£</div>
        <div class="force-label">OP ç¸½æ·¨å£æ•¸ (Callæ·¨ - Putæ·¨)</div>
        <div class="army-stats">
            <div>ğŸ”´ Callæ·¨: <span id="bull-force" style="color:var(--red)">--</span></div>
            <div>ğŸŸ¢ Putæ·¨: <span id="bear-force" style="color:var(--green)">--</span></div>
        </div>
        <div id="logic-text" class="logic-text">åˆ†æä¸­...</div>
    </div>

    <div class="label" style="margin-bottom:8px">ğŸš§ æˆ°å ´é‚Šç•Œ (å£“åŠ› / æ”¯æ’)</div>
    <div class="range-box">
        <div class="range-row">
            <div class="range-title c-green">ğŸŸ¢ å£“åŠ›ç‰†</div>
            <div class="range-val c-green">
                <span id="p-strike">--</span>
                <span class="range-old" id="p-old-box" style="display:none;">
                    <span class="arrow-icon">â¬…</span> <span id="p-old">--</span>
                </span>
                <span id="p-vol" class="range-vol">(--)</span>
            </div>
        </div>
        <div class="range-row">
            <div class="range-title c-red">ğŸ”´ æ”¯æ’ç‰†</div>
            <div class="range-val c-red">
                <span id="s-strike">--</span>
                <span class="range-old" id="s-old-box" style="display:none;">
                    <span class="arrow-icon">â¬…</span> <span id="s-old">--</span>
                </span>
                <span id="s-vol" class="range-vol">(--)</span>
            </div>
        </div>
    </div>

    <div class="label" style="margin-bottom:8px">ğŸ“Š ç±Œç¢¼åˆ†ä½ˆ</div>
    <div class="chip-grid">
      <div class="chip-card" id="c1-card"><span class="label">è¿‘ å…¨æ—¥ (E5)</span><span id="c1-val" class="big-val" style="font-size:20px">--</span><span id="c1-tag" class="chip-tag">--</span></div>
      <div class="chip-card" id="c2-card"><span class="label">è¿‘ æ—¥ç›¤ (E6)</span><span id="c2-val" class="big-val" style="font-size:20px">--</span><span id="c2-tag" class="chip-tag">--</span></div>
      <div class="chip-card" id="c3-card"><span class="label">æ¬¡ å…¨æ—¥</span><span id="c3-val" class="big-val" style="font-size:20px">--</span><span id="c3-tag" class="chip-tag">--</span></div>
      <div class="chip-card" id="c4-card"><span class="label">æ¬¡ æ—¥ç›¤</span><span id="c4-val" class="big-val" style="font-size:20px">--</span><span id="c4-tag" class="chip-tag">--</span></div>
    </div>

    <div class="label" style="margin-top:25px; margin-bottom:8px">ğŸ“ˆ æˆ°æƒ…è¶¨å‹¢ (ä¸Š:ç±Œç¢¼ / ä¸‹:å‹•èƒ½)</div>
    <div class="chart-box">
        <canvas id="trendChart"></canvas>
    </div>
  </div>

  <script>
    // --- Config ---
    const MY_PASSWORD = "168"; 
    const FIREBASE_URL = "https://tx-monitor-93eb2-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
    const NODE_NAME = 'monitor_history'; 

    let trendChart = null;
    let currentChipLabel = "ç±Œç¢¼"; // å‹•æ…‹æ¨™é¡Œ

    // --- Login ---
    function checkPass() {
      if (document.getElementById('pass-input').value === MY_PASSWORD) {
        document.getElementById('login-overlay').style.opacity = '0';
        setTimeout(() => { 
          document.getElementById('login-overlay').style.display = 'none'; 
          document.getElementById('dashboard').classList.add('unlocked');
        }, 500);
        initFirebase();
        initChart();
      } else {
        document.getElementById('error-msg').innerText = "å¯†ç¢¼éŒ¯èª¤";
        document.getElementById('pass-input').value = "";
      }
    }

    // --- Firebase ---
    function initFirebase() {
      if (!firebase.apps.length) firebase.initializeApp({ databaseURL: FIREBASE_URL });
      const dbRef = firebase.database().ref(NODE_NAME);

      dbRef.limitToLast(1).on('child_added', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            updateUI(data);
            updateChartNewData(data); 
        }
      });
      
      dbRef.limitToLast(60).once('value', (snapshot) => {
        const fullData = snapshot.val();
        if(fullData) {
            const dataArray = Object.values(fullData);
            loadChartHistory(dataArray);
        }
      });
    }

    // --- Helper: åˆ¤æ–·æ˜¯å¦ç‚ºæ—¥ç›¤ (08:00 ~ 14:00) ---
    function isDaySession() {
        const h = new Date().getHours();
        return (h >= 8 && h < 14);
    }

    // --- Helper: æ ¹æ“šæ™‚æ®µå–å¾—å°æ‡‰ç±Œç¢¼æ•¸å€¼èˆ‡æ¨™é¡Œ ---
    function getChipDataBasedOnTime(d) {
        if (isDaySession()) {
            return { val: parseChipValue(d.c2), label: "ç±Œç¢¼ (è¿‘ æ—¥ç›¤ E6)", color: '#ffd60a' }; // é»ƒè‰²
        } else {
            return { val: parseChipValue(d.c1), label: "ç±Œç¢¼ (è¿‘ å…¨æ—¥ E5)", color: '#30d158' }; // ç¶ è‰²
        }
    }

    // --- Chart Logic ---
    function updateChartNewData(d) {
        if (!trendChart) return;
        
        let p6Raw = parseFloat((d.pwr_t || "0").replace("%", "").replace("+", ""));
        let chipInfo = getChipDataBasedOnTime(d); // æ™ºæ…§åˆ‡æ›

        // æ›´æ–°æ•¸æ“š
        trendChart.data.labels.push(d.t.substring(0,5)); 
        trendChart.data.datasets[0].data.push(chipInfo.val); // ä¸ŠåŠéƒ¨: ç±Œç¢¼
        trendChart.data.datasets[1].data.push(p6Raw);       // ä¸‹åŠéƒ¨: P6

        // æ›´æ–°æ¨™é¡Œèˆ‡é¡è‰² (å³æ™‚åæ‡‰æ—¥å¤œç›¤åˆ‡æ›)
        trendChart.data.datasets[0].label = chipInfo.label;
        trendChart.data.datasets[0].borderColor = chipInfo.color;

        if (trendChart.data.labels.length > 60) {
            trendChart.data.labels.shift();
            trendChart.data.datasets[0].data.shift();
            trendChart.data.datasets[1].data.shift();
        }
        trendChart.update('none');
    }

    function loadChartHistory(dataArray) {
        if (!trendChart) return;
        let labels = [], dataP6 = [], dataChips = [];
        
        // è¼‰å…¥æ­·å²æ™‚ï¼Œä»¥ã€Œç•¶ä¸‹æ™‚é–“ã€æ±ºå®šè¦ç§€å“ªä¸€æ¢ç·šï¼Œä¿æŒåœ–è¡¨ä¸€è‡´æ€§
        let chipMeta = getChipDataBasedOnTime({}); // å–å¾—ç•¶å‰æ™‚æ®µè¨­å®š

        dataArray.forEach(d => {
            labels.push(d.t.substring(0,5));
            dataP6.push(parseFloat((d.pwr_t || "0").replace("%", "").replace("+", "")));
            
            // æ ¹æ“šç•¶å‰æ™‚æ®µæ±ºå®šæ­·å²è³‡æ–™è¦è®€å– E5 é‚„æ˜¯ E6
            if (isDaySession()) {
                dataChips.push(parseChipValue(d.c2)); // E6
            } else {
                dataChips.push(parseChipValue(d.c1)); // E5
            }
        });

        trendChart.data.labels = labels;
        trendChart.data.datasets[0].data = dataChips;
        trendChart.data.datasets[0].label = chipMeta.label;
        trendChart.data.datasets[0].borderColor = chipMeta.color;
        
        trendChart.data.datasets[1].data = dataP6;
        trendChart.update();
    }

    function parseChipValue(str) {
        if (!str) return 0;
        let valStr = str.split('|')[0].replace('%', '');
        return parseFloat(valStr);
    }

    function initChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        // é è¨­é¡è‰²ï¼Œæœƒè¢« update è¦†è“‹
        let initialChipConfig = getChipDataBasedOnTime({});

        trendChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [
                    // Dataset 0: ç±Œç¢¼ (ä¸Šæ–¹ 50%)
                    { 
                        label: initialChipConfig.label, 
                        data: [], 
                        borderColor: initialChipConfig.color, 
                        borderWidth: 2, 
                        pointRadius: 0, 
                        tension: 0.4, 
                        yAxisID: 'y_chips' 
                    },
                    // Dataset 1: P6 å‹•èƒ½ (ä¸‹æ–¹ 50%)
                    { 
                        label: 'P6 å‹•èƒ½', 
                        data: [], 
                        borderColor: '#ff453a', // ç´…è‰²
                        backgroundColor: 'rgba(255, 69, 58, 0.1)', 
                        borderWidth: 2, 
                        tension: 0.4, 
                        fill: true, 
                        yAxisID: 'y_p6'
                    }
                ]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false, 
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { labels: { color: '#aaa', font: {size: 11} } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        ticks: { color: '#666', maxTicksLimit: 6 }, 
                        grid: { display: false } 
                    },
                    // --- é—œéµè¨­å®šï¼š50/50 åˆ†å‰² ---
                    // ä¸Šæ–¹å€åŸŸ (stackWeight: 1)
                    y_chips: { 
                        type: 'linear', 
                        display: true, 
                        position: 'left', 
                        stack: 'demo', 
                        stackWeight: 1,  // æ¬Šé‡ 1
                        grid: { color: '#333' }, 
                        ticks: { color: '#aaa', callback: function(val){ return val + '%' } },
                        border: { color: '#666' }
                    },
                    // ä¸‹æ–¹å€åŸŸ (stackWeight: 1)
                    y_p6: { 
                        type: 'linear', 
                        display: true, 
                        position: 'left', 
                        stack: 'demo', 
                        stackWeight: 1,  // æ¬Šé‡ 1 (èˆ‡ä¸Šæ–¹å‡åˆ†)
                        offset: true, 
                        grid: { color: '#222', drawOnChartArea: true }, 
                        ticks: { color: '#ff453a', callback: function(val){ return val + '%' } },
                        suggestedMin: -20, 
                        suggestedMax: 20 
                    }
                }
            }
        });
    }

    // --- UI Update Logic ---
    function updateUI(data) {
      document.getElementById('price').innerText = data.p;
      document.getElementById('update-time').innerText = "Update: " + data.t;
      document.getElementById('vwap-day').innerText = data.vwap_day || "--";
      document.getElementById('vwap-night').innerText = data.vwap_night || "--";

      let pVal = 0; let pText = "--%";
      if (data.pwr_v !== undefined) { pVal = parseFloat(data.pwr_v); pText = data.pwr_t; }
      
      let pEl = document.getElementById('pwr-val');
      let pTag = document.getElementById('pwr-tag');
      let pBox = document.getElementById('pwr-box');
      
      pEl.innerText = pText;
      pEl.className = "power-val " + (pVal > 0 ? "c-red" : (pVal < 0 ? "c-green" : ""));
      pBox.className = "box"; 
      if (Math.abs(pVal) >= 20) pBox.classList.add(pVal > 0 ? "alert-red" : "alert-green");
      
      pTag.className = "chip-tag"; pTag.style = "align-self: flex-end;";
      if (pVal > 25) { pTag.className += " bg-red"; pTag.innerText = "æ¥µå¼·å¤šé ­"; }
      else if (pVal >= 10) { pTag.className += " bg-red"; pTag.innerText = "å¤šæ–¹æ§ç›¤"; }
      else if (pVal <= -25) { pTag.className += " bg-green"; pTag.innerText = "æ¥µå¼·ç©ºé ­"; }
      else if (pVal <= -10) { pTag.className += " bg-green"; pTag.innerText = "ç©ºæ–¹æ§ç›¤"; }
      else { pTag.innerText = "éœ‡ç›ªæ•´ç†"; }

      let bullF = parseFloat(data.bull_f || 0);
      let bearF = parseFloat(data.bear_f || 0);
      let force = parseFloat(data.force || 0); 
      let bullR = parseFloat(data.bull_r || 50);
      let bearR = 100 - bullR;

      document.getElementById('bull-force').innerText = bullF;
      document.getElementById('bear-force').innerText = bearF;
      document.getElementById('bull-bar').style.width = bullR + "%";
      document.getElementById('bear-bar').style.width = bearR + "%";
      document.getElementById('ratio-text').innerText = Math.round(bullR) + "%  vs  " + Math.round(bearR) + "%";
      let forceEl = document.getElementById('net-force-val');
      forceEl.innerText = (force > 0 ? "+" : "") + force + " å£";
      forceEl.className = "force-display " + (force > 0 ? "c-red" : (force < 0 ? "c-green" : ""));

      let logicText = data.logic || "åˆ†æä¸­...";
      let logicEl = document.getElementById('logic-text');
      let battleCard = document.getElementById('battle-card');
      logicEl.innerText = logicText;
      battleCard.className = "battle-box"; 
      if (force >= 1500) { logicEl.style.color = "var(--red)"; battleCard.classList.add("alert-red"); }
      else if (force <= -1500) { logicEl.style.color = "var(--green)"; battleCard.classList.add("alert-green"); }
      else { logicEl.style.color = "#aaa"; }

      let ps = parseInt(data.now_p_s || 0); let pv = parseInt(data.now_p_v || 0);
      let ss = parseInt(data.now_s_s || 0); let sv = parseInt(data.now_s_v || 0);
      let lps = parseInt(data.last_p_s || 0); let lss = parseInt(data.last_s_s || 0);

      document.getElementById('p-strike').innerText = ps > 0 ? ps : "--";
      document.getElementById('p-vol').innerText = ps > 0 ? "("+pv+")" : "";
      document.getElementById('s-strike').innerText = ss > 0 ? ss : "--";
      document.getElementById('s-vol').innerText = ss > 0 ? "("+sv+")" : "";
      
      let pOldBox = document.getElementById('p-old-box');
      if (lps > 0 && lps !== ps) { pOldBox.style.display = "inline-flex"; document.getElementById('p-old').innerText = lps; } 
      else { pOldBox.style.display = "none"; }
      let sOldBox = document.getElementById('s-old-box');
      if (lss > 0 && lss !== ss) { sOldBox.style.display = "inline-flex"; document.getElementById('s-old').innerText = lss; } 
      else { sOldBox.style.display = "none"; }

      // æ¨™ç±¤æ›´æ–°
      const chipLabels = {
          'c1': 'è¿‘ å…¨æ—¥ (E5)',
          'c2': 'è¿‘ æ—¥ç›¤ (E6)',
          'c3': 'æ¬¡ å…¨æ—¥',
          'c4': 'æ¬¡ æ—¥ç›¤'
      };

      ['c1','c2','c3','c4'].forEach(id => {
        let raw = data[id]; if(!raw) return;
        let parts = raw.split('|');
        let v = parseFloat(parts[0].replace('%',''));
        
        let el = document.getElementById(id+'-val');
        el.innerText = parts[0]; 
        el.className = "big-val " + (v>0?"c-red":(v<0?"c-green":"")); 
        
        let tag = document.getElementById(id+'-tag');
        tag.innerText = parts[1]; 
        tag.className = "chip-tag " + (parts[1].includes("å¤š")?"bg-red":(parts[1].includes("ç©º")?"bg-green":""));
        
        let card = document.getElementById(id+'-card');
        if(parts[1].includes("å¼·")) card.style.border = v>0?"1px solid rgba(255,69,58,0.3)":"1px solid rgba(48,209,88,0.3)";
        else card.style.border = "none";

        // æ›´æ–°å¡ç‰‡æ¨™é¡Œ
        let labelSpan = card.querySelector('.label');
        if(labelSpan && chipLabels[id]) labelSpan.innerText = chipLabels[id];
      });
    }
  </script>
</body>
</html>
