<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ¥µé€Ÿæˆ°æƒ…å®¤ (Pro Max - å¯©æ ¸åˆ¶)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* === æ ¸å¿ƒæ¨£å¼ === */
    :root { --bg:#000; --card:#1c1c1e; --text:#fff; --red:#ff453a; --green:#30d158; --yellow:#ffd60a; --blue:#0a84ff; --gray:#8e8e93; }
    body { background:var(--bg); color:var(--text); font-family:-apple-system, sans-serif; padding:15px; margin:0; overflow-x:hidden; }
    
    /* å„€è¡¨æ¿é è¨­æ¨¡ç³Š (æœªç™»å…¥ç‹€æ…‹) */
    .dashboard-container { filter: blur(15px); transition: filter 0.5s; pointer-events: none; opacity: 0.3; }
    .unlocked { filter: blur(0); pointer-events: auto; opacity: 1; }

    /* === å„€è¡¨æ¿æ’ç‰ˆ (Pro Max) === */
    .top-section { display:grid; grid-template-columns:1fr 1.3fr; gap:12px; margin-bottom:15px; }
    .box { background:var(--card); border-radius:18px; padding:16px; display:flex; flex-direction:column; justify-content:space-between; }
    
    .big-val { font-size:32px; font-weight:600; letter-spacing:-1px; margin-top:5px; }
    .power-val { font-size:38px; font-weight:700; text-align:right; } 
    .chip-tag { font-size:11px; padding:3px 8px; border-radius:6px; width:fit-content; background:#333; color:#ccc; }
    
    .chip-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .chip-card { background:var(--card); padding:12px; border-radius:14px; display:flex; flex-direction:column; }
    .label { font-size:12px; color:var(--gray); font-weight:600; text-transform:uppercase; }
    
    /* é¡è‰²å®šç¾© */
    .c-red { color:var(--red); } .c-green { color:var(--green); }
    .bg-red { background:rgba(255, 69, 58, 0.15); color:var(--red); } 
    .bg-green { background:rgba(48, 209, 88, 0.15); color:var(--green); }
    .alert-red { border: 1px solid var(--red) !important; box-shadow: 0 0 15px rgba(255, 69, 58, 0.2); }
    .alert-green { border: 1px solid var(--green) !important; box-shadow: 0 0 15px rgba(48, 209, 88, 0.2); }

    /* å¤šç©ºå°æˆ°æ¢ */
    .battle-box { background: var(--card); border-radius: 18px; padding: 16px; margin-bottom: 5px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
    .tug-container { height: 24px; background: #111; border-radius: 12px; position: relative; overflow: hidden; display: flex; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); margin-bottom: 5px; }
    .bull-bar { height: 100%; background: var(--red); transition: width 0.5s; }
    .bear-bar { height: 100%; background: var(--green); transition: width 0.5s; }
    .percent-text { position: absolute; width: 100%; text-align: center; top: 4px; font-size: 12px; font-weight: bold; color: rgba(255,255,255,0.8); text-shadow: 0 1px 2px #000; z-index: 5; letter-spacing: 1px; }
    .force-display { text-align: center; font-size: 28px; font-weight: 800; margin: 5px 0; letter-spacing: -0.5px; }
    .force-label { text-align: center; font-size: 12px; color: var(--gray); margin-top: -5px; }
    .army-stats { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; margin-top: 5px; padding: 0 10px; }
    .logic-text { text-align: center; font-size: 16px; font-weight: 700; color: #fff; margin-top: 2px; letter-spacing: 0.5px; }

    /* P9 å¯¦å–®åŠ›é“æ¨£å¼ */
    .p9-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 10px; }
    .p9-label { font-size: 13px; color: #aaa; font-weight: 600; }
    .p9-val { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; }

    /* === æ–°å¢ï¼šAI æˆ°ç•¥æŒ‡æ®å®˜å€å¡Š === */
    .strategy-card { background: #2c2c2e; border-radius: 14px; padding: 12px; margin-bottom: 15px; border: 1px solid #444; font-size: 13px; position: relative; overflow: hidden; }
    .strategy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 5px; }
    .phase-badge { background: #0a84ff; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .strategy-content { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; }
    .strategy-item { display: flex; flex-direction: column; }
    .s-label { color: #888; font-size: 11px; margin-bottom: 2px; }
    .s-val { color: #fff; font-weight: 600; font-size: 13px; }
    .s-advice { grid-column: 1 / -1; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; color: #ddd; line-height: 1.4; margin-top: 5px; border-left: 3px solid #888; }
    
    /* æˆ°å ´é‚Šç•Œ */
    .range-box { background: var(--card); border-radius: 18px; padding: 12px 16px; margin-bottom: 15px; display: grid; grid-template-rows: 1fr 1fr; gap: 10px; position: relative; overflow: hidden; }
    .range-box::after { content: ""; position: absolute; top: 50%; left: 16px; right: 16px; height: 1px; background: #333; }
    .range-row { display: flex; justify-content: space-between; align-items: center; }
    .range-title { font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .range-val { font-size: 20px; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .range-vol { font-size: 11px; color: #666; font-weight: normal; margin-left: 4px; }
    .range-old { font-size: 12px; color: #666; font-weight: normal; display: flex; align-items: center; }
    .arrow-icon { font-size: 10px; margin: 0 4px; color: #444; }

    /* â˜…â˜…â˜… ä¿®æ”¹ï¼šæ‹†åˆ†ç‚ºä¸‰å€‹ç¨ç«‹çš„åœ–è¡¨å€å¡Šï¼Œé«˜åº¦è¼ƒå°ä½†å„è‡ªç¨ç«‹ â˜…â˜…â˜… */
    .split-chart-box { background: var(--card); border-radius: 18px; padding: 10px; margin-top: 5px; margin-bottom: 15px; height: 280px; position: relative; }
    .section-title { margin-top: 25px; margin-bottom: 5px; font-size: 13px; color: #888; display: flex; align-items: center; gap: 5px; font-weight: 600; }

    /* === ç™»å…¥/è¨»å†Š/å¯©æ ¸ é®ç½©æ¨£å¼ === */
    #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .auth-box { text-align: center; width: 85%; max-width: 320px; background: #1c1c1e; padding: 30px 20px; border-radius: 20px; border: 1px solid #333; }
    .auth-title { font-size: 22px; font-weight: 700; color: #fff; margin-bottom: 20px; }
    
    .auth-input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #333; background: #2c2c2e; color: #fff; font-size: 16px; box-sizing: border-box; }
    .auth-input:focus { border-color: var(--blue); outline: none; }
    
    .auth-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--blue); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
    .auth-btn:active { opacity: 0.8; }
    .auth-btn.secondary { background: #3a3a3c; margin-top: 10px; }
    
    .error-msg { color: var(--red); font-size: 13px; margin-top: 15px; min-height: 18px; line-height: 1.4; }
    .toggle-link { margin-top: 20px; font-size: 14px; color: var(--blue); cursor: pointer; text-decoration: underline; }

    /* ç™»å‡ºæŒ‰éˆ• */
    #logout-btn { position: fixed; top: 15px; right: 15px; z-index: 1000; display: none; padding: 6px 12px; background: rgba(28,28,30,0.8); border: 1px solid #444; color: #aaa; border-radius: 20px; font-size: 12px; cursor: pointer; backdrop-filter: blur(5px); }

    /* === æ–°å¢ï¼šæˆ°åŠ›åˆ†ç´šæ¨£å¼ (S/A/B) === */
    .rank-s { color: #d4af37 !important; text-shadow: 0 0 10px rgba(212, 175, 55, 0.8); animation: pulse-gold 1.5s infinite; border: 1px solid #d4af37 !important; }
    .rank-a-bull { color: var(--red) !important; border: 1px solid var(--red) !important; }
    .rank-a-bear { color: var(--green) !important; border: 1px solid var(--green) !important; }
    .rank-b { color: var(--yellow) !important; border: 1px solid var(--yellow) !important; }
    .rank-n { color: #888 !important; border: 1px solid #444 !important; }

    @keyframes pulse-gold {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
  </style>
</head>
<body>

  <div id="auth-overlay">
    
    <div id="login-form" class="auth-box">
      <div class="auth-title">ğŸ” æœƒå“¡ç™»å…¥</div>
      <input type="email" id="login-email" class="auth-input" placeholder="Email ä¿¡ç®±">
      <input type="password" id="login-pass" class="auth-input" placeholder="å¯†ç¢¼">
      <button onclick="doLogin()" class="auth-btn">é€²å…¥æˆ°æƒ…å®¤</button>
      <div class="error-msg" id="login-msg"></div>
      <div class="toggle-link" onclick="showRegister()">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</div>
    </div>

    <div id="register-form" class="auth-box" style="display:none;">
      <div class="auth-title">ğŸ“ è¨»å†Šæ–°å¸³è™Ÿ</div>
      <div style="font-size:12px; color:#aaa; margin-bottom:15px;">è¨»å†Šå¾Œè«‹è‡³ä¿¡ç®±é»æ“Šé©—è­‰é€£çµ<br>ä¸¦ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸</div>
      <input type="email" id="reg-email" class="auth-input" placeholder="è¼¸å…¥æ‚¨çš„ Email">
      <input type="password" id="reg-pass" class="auth-input" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)">
      <button onclick="doRegister()" class="auth-btn secondary">è¨»å†Šä¸¦ç™¼é€é©—è­‰ä¿¡</button>
      <div class="error-msg" id="reg-msg" style="color:var(--yellow)"></div>
      <div class="toggle-link" onclick="showLogin()">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</div>
    </div>
  </div>

  <button id="logout-btn" onclick="doLogout()">ç™»å‡º</button>

  <div class="dashboard-container" id="dashboard">
    <div class="top-section">
      <div class="box">
        <div class="label">TX å°æŒ‡æœŸ</div>
        <div id="price" class="big-val">---</div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:13px; color:#aaa; font-weight:500;">
            <div>ğŸŒ æ—¥ <span id="vwap-day" style="color:#fff; font-weight:600; margin-left:2px;">--</span></div>
            <div>ğŸŒ™ å¤œ <span id="vwap-night" style="color:#fff; font-weight:600; margin-left:2px;">--</span></div>
        </div>
        <div id="update-time" class="label" style="margin-top:8px; color:#666; font-size:10px; text-align:right;">--:--:--</div>
      </div>
      <div class="box" style="text-align:right" id="pwr-box">
        <div class="label">ğŸš€ P6 è²·æ–¹å‹•èƒ½</div>
        <div id="pwr-val" class="power-val">0%</div>
        <div id="pwr-tag" class="chip-tag" style="align-self: flex-end;">Wait</div>
      </div>
    </div>

    <div class="label" style="margin-bottom:8px">âš”ï¸ OP å¤šç©ºåŠ›é“ (å…§å¤–ç›¤å·®)</div>
    <div class="battle-box" id="battle-card">
        <div class="tug-container">
            <div id="bull-bar" class="bull-bar" style="width: 50%;"></div>
            <div id="bear-bar" class="bear-bar" style="width: 50%;"></div>
            <div id="ratio-text" class="percent-text">50% vs 50%</div>
        </div>
        <div id="net-force-val" class="force-display">-- å£</div>
        <div class="army-stats">
            <div>ğŸ”´ Callæ·¨: <span id="bull-force" style="color:var(--red)">--</span></div>
            <div>ğŸŸ¢ Putæ·¨: <span id="bear-force" style="color:var(--green)">--</span></div>
        </div>
        
        <div class="p9-container">
            <div class="p9-label">ğŸ”¥ å¯¦å–®åŠ›é“ (P9):</div>
            <div id="p9-val" class="p9-val">--</div>
        </div>

        <div id="logic-text" class="logic-text">åˆ†æä¸­...</div>
    </div>

    <div id="strategy-box" class="strategy-card">
        <div class="strategy-header">
            <div style="color:#ccc; font-weight:600;">ğŸ¤– AI æˆ°ç•¥æŒ‡æ®</div>
            <div id="st-phase" class="phase-badge">ç­‰å¾…æ•¸æ“š</div>
        </div>
        <div class="strategy-content">
            <div class="strategy-item">
                <div class="s-label">ğŸ¯ é—œæ³¨ç„¦é»</div>
                <div id="st-focus" class="s-val">--</div>
            </div>
            <div class="strategy-item">
                <div class="s-label">âš–ï¸ æ¬Šé‡é…ç½®</div>
                <div id="st-weight" class="s-val">--</div>
            </div>
            <div id="st-advice" class="s-advice">
                åˆ†æä¸­...
            </div>
        </div>
    </div>

    <div class="label" style="margin-bottom:8px">ğŸš§ æˆ°å ´é‚Šç•Œ (å£“åŠ› / æ”¯æ’)</div>
    <div class="range-box">
        <div class="range-row">
            <div class="range-title c-green">ğŸŸ¢ å£“åŠ›ç‰†</div>
            <div class="range-val c-green">
                <span id="p-strike">--</span>
                <span class="range-old" id="p-old-box" style="display:none;">
                    <span class="arrow-icon">â¬…</span> <span id="p-old">--</span>
                </span>
                <span id="p-vol" class="range-vol">(--)</span>
            </div>
        </div>
        <div class="range-row">
            <div class="range-title c-red">ğŸ”´ æ”¯æ’ç‰†</div>
            <div class="range-val c-red">
                <span id="s-strike">--</span>
                <span class="range-old" id="s-old-box" style="display:none;">
                    <span class="arrow-icon">â¬…</span> <span id="s-old">--</span>
                </span>
                <span id="s-vol" class="range-vol">(--)</span>
            </div>
        </div>
    </div>

    <div class="label" style="margin-bottom:8px">ğŸ“Š ç±Œç¢¼åˆ†ä½ˆ</div>
    <div class="chip-grid">
      <div class="chip-card" id="c1-card"><span class="label">è¿‘æœˆ å¤œç›¤ (E5)</span><span id="c1-val" class="big-val" style="font-size:20px">--</span><span id="c1-tag" class="chip-tag">--</span></div>
      <div class="chip-card" id="c2-card"><span class="label">è¿‘æœˆ æ—¥ç›¤ (E6)</span><span id="c2-val" class="big-val" style="font-size:20px">--</span><span id="c2-tag" class="chip-tag">--</span></div>
      <div class="chip-card" id="c3-card"><span class="label">æ¬¡æœˆ å¤œç›¤</span><span id="c3-val" class="big-val" style="font-size:20px">--</span><span id="c3-tag" class="chip-tag">--</span></div>
      <div class="chip-card" id="c4-card"><span class="label">æ¬¡æœˆ æ—¥ç›¤</span><span id="c4-val" class="big-val" style="font-size:20px">--</span><span id="c4-tag" class="chip-tag">--</span></div>
    </div>

    <div class="section-title">ğŸ“ˆ æœŸè²¨ç¾åƒ¹ (Price)</div>
    <div class="split-chart-box">
        <canvas id="chartPrice"></canvas>
    </div>

    <div class="section-title">ğŸ“Š ç±Œç¢¼åŠ›é“ (R7)</div>
    <div class="split-chart-box">
        <canvas id="chartChip"></canvas>
    </div>

    <div class="section-title">ğŸš€ P6å‹•èƒ½(å·¦) vs P9å¯¦å–®(å³)</div>
    <div class="split-chart-box">
        <canvas id="chartP6"></canvas>
    </div>

  </div>

  <script>
    // â˜…â˜…â˜… 1. æ‚¨çš„ Firebase Config â˜…â˜…â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyCPkFmEOfCRBBR6TQbji8G5kNZk7XBi_JQ",
      authDomain: "tx-monitor-93eb2.firebaseapp.com",
      databaseURL: "https://tx-monitor-93eb2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tx-monitor-93eb2",
      storageBucket: "tx-monitor-93eb2.firebasestorage.app",
      messagingSenderId: "351988516076",
      appId: "1:351988516076:web:1127a8cc9144db8f3951c9"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    const NODE_REALTIME = 'monitor_realtime';
    const NODE_HISTORY  = 'monitor_history';

    let chartPrice = null; let chartChip = null; let chartP6 = null;

    // ==========================================================
    // 2. Auth é‚è¼¯ (ç™»å…¥/è¨»å†Š)
    // ==========================================================
    auth.onAuthStateChanged((user) => {
      const overlay = document.getElementById('auth-overlay');
      const dashboard = document.getElementById('dashboard');
      const logoutBtn = document.getElementById('logout-btn');
      const loginMsg = document.getElementById('login-msg');

      if (user) {
        if (!user.emailVerified) {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            loginMsg.innerHTML = `âš ï¸ Email å°šæœªé©—è­‰ï¼<br>è«‹å»ä¿¡ç®±ç¢ºèªï¼Œå®Œæˆå¾Œè«‹<a href="#" onclick="location.reload()" style="color:#fff">é‡æ–°æ•´ç†</a>`;
            auth.signOut();
            return;
        }
        const userRef = db.ref('users/' + user.uid);
        userRef.once('value').then((snapshot) => {
            const userData = snapshot.val();
            if (!userData) {
                userRef.set({ email: user.email, approved: false, reg_time: new Date().toISOString() }).then(() => { showPendingScreen(); });
            } else if (userData.approved === true) {
                overlay.style.display = 'none';
                if(document.getElementById('pending-msg-box')) document.getElementById('pending-msg-box').style.display = 'none';
                dashboard.classList.add('unlocked');
                logoutBtn.style.display = 'block';
                if(!chartPrice) { initCharts(); startDataSync(); }
            } else {
                showPendingScreen();
            }
        });
      } else {
        overlay.style.display = 'flex';
        document.getElementById('login-form').style.display = 'block';
        if(document.getElementById('pending-msg-box')) document.getElementById('pending-msg-box').style.display = 'none';
        dashboard.classList.remove('unlocked');
        logoutBtn.style.display = 'none';
      }
    });

    function showPendingScreen() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'none';
        let pendingBox = document.getElementById('pending-msg-box');
        if (!pendingBox) {
            pendingBox = document.createElement('div');
            pendingBox.id = 'pending-msg-box';
            pendingBox.className = 'auth-box';
            pendingBox.innerHTML = `<div class="auth-title">â³ å¯©æ ¸ä¸­</div><div style="color:#ccc; font-size:14px; line-height:1.6; margin-bottom:20px;">æ‚¨çš„å¸³è™Ÿå·²å»ºç«‹ï¼Œä½†éœ€è¦ç®¡ç†å“¡æ ¸å‡†æ‰èƒ½é€²å…¥ã€‚<br>è«‹é€šçŸ¥ç®¡ç†å“¡é–‹é€šæ‚¨çš„æ¬Šé™ã€‚</div><button onclick="location.reload()" class="auth-btn">æˆ‘å·²é–‹é€šï¼Œé‡æ–°æ•´ç†</button><button onclick="doLogout()" class="auth-btn secondary">ç™»å‡º</button>`;
            document.getElementById('auth-overlay').appendChild(pendingBox);
        }
        pendingBox.style.display = 'block';
    }

    function doLogin() {
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-pass').value;
      const msgBox = document.getElementById('login-msg');
      msgBox.innerText = "é©—è­‰ä¸­...";
      auth.signInWithEmailAndPassword(email, pass).catch((error) => { msgBox.innerText = "âŒ ç™»å…¥å¤±æ•—: " + error.code; });
    }

    function doRegister() {
      const email = document.getElementById('reg-email').value;
      const pass = document.getElementById('reg-pass').value;
      const msgBox = document.getElementById('reg-msg');
      if (pass.length < 6) { msgBox.innerText = "âš ï¸ å¯†ç¢¼å¤ªçŸ­"; return; }
      msgBox.innerText = "å»ºç«‹å¸³è™Ÿä¸­...";
      auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
          cred.user.sendEmailVerification().then(() => {
             msgBox.innerHTML = "âœ… é©—è­‰ä¿¡å·²ç™¼é€ï¼è«‹å»ä¿¡ç®±ç¢ºèªã€‚";
             setTimeout(() => { showLogin(); auth.signOut(); }, 5000);
          });
      }).catch((e) => { msgBox.innerText = e.message; });
    }

    function doLogout() { if(confirm("ç¢ºå®šç™»å‡ºï¼Ÿ")) { auth.signOut(); location.reload(); } }
    function showRegister() { document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; }
    function showLogin() { document.getElementById('login-form').style.display='block'; document.getElementById('register-form').style.display='none'; }

    // ==========================================================
    // 3. æˆ°ç•¥æ ¸å¿ƒèˆ‡åœ–è¡¨
    // ==========================================================
    function startDataSync() {
      db.ref(NODE_REALTIME).on('value', (s) => { if(s.val()) updateUI(s.val()); });
      db.ref(NODE_HISTORY).limitToLast(1).on('child_added', (s) => { if(s.val()) updateChartNewData(s.val()); });
      db.ref(NODE_HISTORY).limitToLast(120).once('value', (s) => { if(s.val()) loadChartHistory(Object.values(s.val())); });
    }

    // â˜…â˜…â˜… [æ ¸å¿ƒ] ä¸‰ç¶­æˆ°åŠ›åˆ†ææ¼”ç®—æ³• (P9 + P7 + E) â˜…â˜…â˜…
    function analyzeStrategy(data) {
        let p9 = parseFloat(data.p9 || 0);
        let p7 = parseFloat(data.force || 0); 
        let timeHour = parseInt((data.t || "00:00").split(':')[0]);
        let isNight = (timeHour >= 15 || timeHour < 6);
        let e_str = isNight ? (data.c1 || "") : (data.c2 || ""); 
        let e_dir = 0;
        if (e_str.includes("å¤š")) e_dir = 1; else if (e_str.includes("ç©º")) e_dir = -1;

        let result = { text: "â˜• [Nç´š] è§€æœ› (ä¿¡å¿ƒ0%)", class: "rank-n" };
        let confidence = 0;

        if (p9 > 2000) {
            let isResonance = (p7 > 0); 
            let isTrend = (e_dir === 1); 
            confidence = 50;
            if (p9 > 10000) confidence += 30; else if (p9 > 5000) confidence += 20; else confidence += 10;
            if (isResonance) confidence += 10;
            if (isTrend) confidence += 10;
            if (p9 > 20000 && !isResonance) confidence = 90; 

            if (p9 > 10000 && isResonance && isTrend) {
                result = { text: `ğŸ”¥ [Sç´š] æµ·å˜¯å¤šé ­ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-s" };
            } else if (p9 > 20000 && !isResonance) {
                result = { text: `ğŸšœ [B+ç´š] å¦å…‹ç¢¾å£“ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-s" };
            } else if (isResonance) {
                result = { text: `ğŸ’ª [Aç´š] é †å‹¢é€²æ”» (ä¿¡å¿ƒ${confidence}%)`, class: "rank-a-bull" };
            } else {
                result = { text: `âš¡ [Bç´š] èª˜ç©ºåè½‰ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-b" };
            }
        }
        else if (p9 < -2000) {
            let isResonance = (p7 < 0);
            let isTrend = (e_dir === -1);
            confidence = 50;
            if (p9 < -10000) confidence += 30; else if (p9 < -5000) confidence += 20; else confidence += 10;
            if (isResonance) confidence += 10;
            if (isTrend) confidence += 10;
            if (p9 < -20000 && !isResonance) confidence = 90;

            if (p9 < -10000 && isResonance && isTrend) {
                result = { text: `â˜ ï¸ [Sç´š] æ¯€æ»…ç©ºé ­ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-s" };
            } else if (p9 < -20000 && !isResonance) {
                result = { text: `ğŸšœ [B+ç´š] å¦å…‹ç¢¾å£“ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-s" };
            } else if (isResonance) {
                result = { text: `ğŸ“‰ [Aç´š] é †å‹¢å£“åˆ¶ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-a-bear" };
            } else {
                result = { text: `ğŸª¤ [Bç´š] èª˜å¤šæ®ºç›¤ (ä¿¡å¿ƒ${confidence}%)`, class: "rank-b" };
            }
        }
        return result;
    }

    // â˜…â˜…â˜… [æ–°å¢] å…¨æ™‚æ®µæˆ°ç•¥æ¬Šé‡è¨ˆç®— (AI Commander) â˜…â˜…â˜…
    function updateStrategyBox(data, strategyResult) {
        let hour = parseInt((data.t || "00:00").split(':')[0]);
        let min = parseInt((data.t || "00:00").split(':')[1]);
        
        let phaseName = "";
        let focusText = "";
        let weightText = "";
        let adviceText = "";

        // æ™‚é–“æ®µåˆ¤æ–·é‚è¼¯
        let isEarly = (hour === 8 && min >= 45) || (hour === 9);
        let isMid = (hour >= 10 && hour < 13);
        let isLate = (hour === 13);
        let isNight = (hour >= 15 || hour < 5);

        if (isEarly) {
            phaseName = "ğŸ•’ æ—©ç›¤è¡é‹’æœŸ (08:45-10:00)";
            focusText = "ğŸ”¥ P9 å¯¦å–® (å³æ™‚å‹•èƒ½)";
            weightText = "P9 (70%) > P7 (20%) > E6 (10%)";
            adviceText = "è¶¨å‹¢æœªå®šï¼Œè«‹ç„¡è¦– E6ï¼Œç·Šç›¯ P9 æ–¹å‘ã€‚è‹¥ P9 > 5000 ä¸” R7 åŒå‘ï¼Œå‹‡æ•¢è¿½åƒ¹ã€‚å¿«é€²å¿«å‡ºï¼Œä¸æˆ€æˆ°ã€‚";
        } else if (isMid) {
            phaseName = "ğŸ•’ ä¸­ç›¤è¶¨å‹¢æœŸ (10:00-13:00)";
            focusText = "âš–ï¸ E6 è¶¨å‹¢ + P9 å‹•èƒ½";
            weightText = "E6 (40%) = P9 (40%) > VWAP (20%)";
            adviceText = "å¤§ç›¤æ–¹å‘å·²å‡º (E6 ç‚ºå¤§æˆ¶æ›å–®çµæ§‹)ã€‚è«‹é †è‘— E6 æ–¹å‘åšå–®ã€‚è‹¥ P9 èˆ‡ E6 èƒŒé›¢ï¼Œè«‹ç­‰å¾…å›æ¸¬ VWAP å†é€²å ´ã€‚";
        } else if (isLate) {
            phaseName = "ğŸ•’ å°¾ç›¤æ±ºç­–æœŸ (13:00-13:45)";
            focusText = "ğŸ“¦ ç•™å€‰è©•ä¼° (E6 + å°¾ç›¤é‡)";
            weightText = "E6 (50%) > P9 (30%) > VWAP (20%)";
            adviceText = "æº–å‚™çµç®—ã€‚è‹¥ E6 (å¤§æˆ¶æ›å–®çµæ§‹) èˆ‡ P9 åŒå‘ä¸”åƒ¹æ ¼åœ¨ VWAP ä¹‹ä¸Šï¼Œå¯è€ƒæ…®ç•™å¤šå–®ã€‚è‹¥æ–¹å‘ä¸ä¸€ï¼Œå»ºè­°ç©ºæ‰‹éå¤œã€‚";
        } else {
            // === ğŸŒ™ å¤œç›¤æ™‚æ®µ (ä¿®æ­£å»ºè­°ï¼šåƒè€ƒæ—¥ç›¤å¤§æˆ¶çµæ§‹ E6) ===
            phaseName = "ğŸŒ™ å¤œç›¤æ™‚æ®µ";
            focusText = "ğŸŒ ç¾è‚¡é€£å‹• + P9 å¯¦å–®";
            weightText = "P9 (60%) > E5 (30%) > E6 (10%)";
            adviceText = "æ³¢å‹•åŠ‡çƒˆï¼ŒP9 ç‚ºç‹ã€‚è«‹åƒè€ƒ <b>E6 (æ—¥ç›¤å¤§æˆ¶æ›å–®çµæ§‹)</b> ä½œç‚ºæ”¯æ’å£“åŠ›ï¼Œä¸¦è§€å¯Ÿ <b>E5 (å¤œç›¤çµæ§‹)</b> æ˜¯å¦åŒå‘ã€‚è‹¥ P9 å‡ºç¾å·¨é‡ï¼Œè«‹å®Œå…¨ä¾ç…§ P9 æŒ‡ç¤ºã€‚";
        }

        // DOM æ›´æ–°
        document.getElementById('st-phase').innerText = phaseName;
        document.getElementById('st-focus').innerText = focusText;
        document.getElementById('st-weight').innerText = weightText;
        
        // æ•´åˆ S/A/B ç´šåˆ¥èˆ‡æ™‚é–“å»ºè­°
        let finalAdvice = `ã€${strategyResult.text}ã€‘<br>${adviceText}`;
        document.getElementById('st-advice').innerHTML = finalAdvice;
        
        // é‚Šæ¡†é¡è‰²éš¨ç­‰ç´šè®ŠåŒ–
        let stCard = document.getElementById('strategy-box');
        stCard.style.borderLeft = "5px solid #444";
        if (strategyResult.class.includes('rank-s')) stCard.style.borderLeft = "5px solid #d4af37";
        else if (strategyResult.class.includes('bull')) stCard.style.borderLeft = "5px solid var(--red)";
        else if (strategyResult.class.includes('bear')) stCard.style.borderLeft = "5px solid var(--green)";
        else if (strategyResult.class.includes('rank-b')) stCard.style.borderLeft = "5px solid var(--yellow)";
    }

    function updateUI(data) {
      document.getElementById('price').innerText = data.p;
      document.getElementById('update-time').innerText = "Update: " + data.t;
      document.getElementById('vwap-day').innerText = data.vwap_day ? Math.round(parseFloat(data.vwap_day)) : "--";
      document.getElementById('vwap-night').innerText = data.vwap_night ? Math.round(parseFloat(data.vwap_night)) : "--";

      let pVal = parseFloat(data.pwr_v || 0);
      let pEl = document.getElementById('pwr-val');
      let pBox = document.getElementById('pwr-box');
      let pTag = document.getElementById('pwr-tag');
      
      pEl.innerText = data.pwr_t || "0%";
      pEl.className = "power-val " + (pVal > 0 ? "c-red" : (pVal < 0 ? "c-green" : ""));
      pBox.className = "box"; 
      if (Math.abs(pVal) >= 20) pBox.classList.add(pVal > 0 ? "alert-red" : "alert-green");
      
      pTag.className = "chip-tag"; pTag.style="align-self:flex-end";
      if(pVal>25){pTag.classList.add("bg-red");pTag.innerText="æ¥µå¼·å¤š";}
      else if(pVal>=10){pTag.classList.add("bg-red");pTag.innerText="åå¤š";}
      else if(pVal<=-25){pTag.classList.add("bg-green");pTag.innerText="æ¥µå¼·ç©º";}
      else if(pVal<=-10){pTag.classList.add("bg-green");pTag.innerText="åç©º";}
      else{pTag.innerText="æ•´ç†";}

      let bullR = parseFloat(data.bull_r || 50);
      let bearR = 100 - bullR;
      document.getElementById('bull-force').innerText = data.bull_f;
      document.getElementById('bear-force').innerText = data.bear_f;
      document.getElementById('bull-bar').style.width = bullR + "%";
      document.getElementById('bear-bar').style.width = bearR + "%";
      document.getElementById('ratio-text').innerText = Math.round(bullR) + "% vs " + Math.round(bearR) + "%";
      
      let force = parseFloat(data.force || 0);
      let fEl = document.getElementById('net-force-val');
      fEl.innerText = (force>0?"+":"") + force + " å£";
      fEl.className = "force-display " + (force>0?"c-red":"c-green");

      let valP9 = parseFloat(data.p9 || 0);
      let p9El = document.getElementById('p9-val');
      p9El.innerText = (valP9>0?"+":"") + valP9.toLocaleString('en-US');
      p9El.className = "p9-val " + (valP9>0?"c-red":(valP9<0?"c-green":""));

      let strategy = analyzeStrategy(data);
      let logicEl = document.getElementById('logic-text');
      let battleCard = document.getElementById('battle-card');
      
      logicEl.innerText = strategy.text;
      battleCard.className = "battle-box " + strategy.class;
      
      if (strategy.class === 'rank-s') logicEl.style.color = "#d4af37";
      else if (strategy.class.includes('bull')) logicEl.style.color = "var(--red)";
      else if (strategy.class.includes('bear')) logicEl.style.color = "var(--green)";
      else if (strategy.class === 'rank-b') logicEl.style.color = "var(--yellow)";
      else logicEl.style.color = "#aaa";

      // â˜…â˜…â˜… å‘¼å« AI æˆ°ç•¥æŒ‡æ®å®˜ â˜…â˜…â˜…
      updateStrategyBox(data, strategy);

      // â˜…â˜…â˜… ä¿®æ­£é–‹å§‹ï¼šæˆ°å ´é‚Šç•Œ (å£“åŠ› / æ”¯æ’) å«èˆŠè³‡æ–™é¡¯ç¤º â˜…â˜…â˜…
      let ps = parseInt(data.now_p_s || 0), pv = parseInt(data.now_p_v || 0);
      let ss = parseInt(data.now_s_s || 0), sv = parseInt(data.now_s_v || 0);
      
      // 1. æ›´æ–°ç›®å‰å£“åŠ›
      document.getElementById('p-strike').innerText = ps > 0 ? ps : "--";
      document.getElementById('p-vol').innerText = ps > 0 ? "(" + pv + ")" : "";
      
      // 2. è™•ç†ã€Œä¸Šä¸€ç­†å£“åŠ›ã€(Old Pressure)
      let old_ps = parseInt(data.old_p_s || 0);
      let pOldBox = document.getElementById('p-old-box');
      if (old_ps > 0 && old_ps !== ps) {
          document.getElementById('p-old').innerText = old_ps;
          pOldBox.style.display = "inline-flex"; // é¡¯ç¤ºèˆŠè³‡æ–™
      } else {
          pOldBox.style.display = "none"; // éš±è—
      }

      // 3. æ›´æ–°ç›®å‰æ”¯æ’
      document.getElementById('s-strike').innerText = ss > 0 ? ss : "--";
      document.getElementById('s-vol').innerText = ss > 0 ? "(" + sv + ")" : "";

      // 4. è™•ç†ã€Œä¸Šä¸€ç­†æ”¯æ’ã€(Old Support)
      let old_ss = parseInt(data.old_s_s || 0);
      let sOldBox = document.getElementById('s-old-box');
      if (old_ss > 0 && old_ss !== ss) {
          document.getElementById('s-old').innerText = old_ss;
          sOldBox.style.display = "inline-flex"; // é¡¯ç¤ºèˆŠè³‡æ–™
      } else {
          sOldBox.style.display = "none"; // éš±è—
      }
      // â˜…â˜…â˜… ä¿®æ­£çµæŸ â˜…â˜…â˜…
      
      const chipLabels = { 'c1': 'è¿‘æœˆ å¤œç›¤ (E5)', 'c2': 'è¿‘æœˆ æ—¥ç›¤ (E6)', 'c3': 'æ¬¡æœˆ å¤œç›¤', 'c4': 'æ¬¡æœˆ æ—¥ç›¤' };
      ['c1','c2','c3','c4'].forEach(id => {
        let raw = data[id]; if(!raw) return;
        let parts = raw.split('|');
        let v = parseFloat(parts[0].replace('%',''));
        let el = document.getElementById(id+'-val');
        el.innerText = parts[0]; 
        el.className = "big-val " + (v>0?"c-red":(v<0?"c-green":"")); 
        let tag = document.getElementById(id+'-tag');
        tag.innerText = parts[1]; 
        tag.className = "chip-tag " + (parts[1].includes("å¤š")?"bg-red":(parts[1].includes("ç©º")?"bg-green":""));
        let card = document.getElementById(id+'-card');
        if(parts[1].includes("å¼·")) card.style.border = v>0?"1px solid rgba(255,69,58,0.3)":"1px solid rgba(48,209,88,0.3)";
        else card.style.border = "none";
        let labelSpan = card.querySelector('.label');
        if(labelSpan && chipLabels[id]) labelSpan.innerText = chipLabels[id];
      });
    }

    function getChipValueForTime(d) {
        let hour = parseInt(d.t.split(':')[0]);
        let isDay = (hour >= 8 && hour < 14);
        if (isDay) return { val: parseChipValue(d.c2), label: "ç±Œç¢¼ (è¿‘æœˆ æ—¥ç›¤ E6)", color: '#ffd60a' }; 
        else return { val: parseChipValue(d.c1), label: "ç±Œç¢¼ (è¿‘æœˆ å¤œç›¤ E5)", color: '#30d158' }; 
    }
    
    function updateChartNewData(d) {
        if (!chartPrice) return;
        let timeLabel = d.t.substring(0,5);
        let p6Raw = parseFloat((d.pwr_t || "0").replace("%", "").replace("+", ""));
        let p9Raw = parseFloat(d.p9 || 0);
        let priceRaw = parseFloat(d.price || 0);
        let chipInfo = getChipValueForTime(d);

        chartPrice.data.labels.push(timeLabel); chartPrice.data.datasets[0].data.push(priceRaw);
        chartChip.data.labels.push(timeLabel); chartChip.data.datasets[0].data.push(chipInfo.val);
        chartChip.data.datasets[0].label = chipInfo.label; chartChip.data.datasets[0].borderColor = chipInfo.color;
        chartP6.data.labels.push(timeLabel); chartP6.data.datasets[0].data.push(p6Raw); chartP6.data.datasets[1].data.push(p9Raw);

        if (chartPrice.data.labels.length > 120) {
            chartPrice.data.labels.shift(); chartPrice.data.datasets[0].data.shift();
            chartChip.data.labels.shift(); chartChip.data.datasets[0].data.shift();
            chartP6.data.labels.shift(); chartP6.data.datasets[0].data.shift(); chartP6.data.datasets[1].data.shift();
        }
        chartPrice.update('none'); chartChip.update('none'); chartP6.update('none');
    }

    function loadChartHistory(dataArray) {
        if (!chartPrice) return;
        let labels=[], dataP=[], dataC=[], dataP6=[], dataP9=[];
        let lastChipInfo={label:"ç±Œç¢¼",color:'#30d158'};
        dataArray.forEach(d => {
            labels.push(d.t.substring(0,5)); dataP.push(parseFloat(d.price||0));
            let info = getChipValueForTime(d); dataC.push(info.val);
            dataP6.push(parseFloat((d.pwr_t||"0").replace("%","").replace("+","")));
            dataP9.push(parseFloat(d.p9||0)); lastChipInfo=info;
        });
        chartPrice.data.labels=labels; chartPrice.data.datasets[0].data=dataP;
        chartChip.data.labels=labels; chartChip.data.datasets[0].data=dataC;
        chartChip.data.datasets[0].label=lastChipInfo.label; chartChip.data.datasets[0].borderColor=lastChipInfo.color;
        chartP6.data.labels=labels; chartP6.data.datasets[0].data=dataP6; chartP6.data.datasets[1].data=dataP9;
        chartPrice.update(); chartChip.update(); chartP6.update();
    }
    
    function parseChipValue(str) { if(!str)return 0; return parseFloat(str.split('|')[0].replace('%','')); }

    function initCharts() {
        const commonOptions = { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { labels: { color: '#aaa', font: {size: 11} } } }, scales: { x: { ticks: { color: '#666', maxTicksLimit: 6 }, grid: { display: false } } } };
        
        chartPrice = new Chart(document.getElementById('chartPrice').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'æœŸè²¨ç¾åƒ¹', data: [], borderColor: '#ffd700', borderWidth: 2, pointRadius: 0, tension: 0.2 }] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { display: true, position: 'right', grid: { color: '#333' }, ticks: { color: '#ffd700' } } } } });
        chartChip = new Chart(document.getElementById('chartChip').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'ç±Œç¢¼', data: [], borderColor: '#30d158', borderWidth: 2, pointRadius: 0, tension: 0.4 }] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { display: true, position: 'left', grid: { color: '#333' }, ticks: { color: '#aaa' } } } } });
        chartP6 = new Chart(document.getElementById('chartP6').getContext('2d'), { type: 'line', data: { labels: [], datasets: [ { label: 'P6 å‹•èƒ½ (%)', data: [], borderColor: '#ff453a', backgroundColor: 'rgba(255, 69, 58, 0.1)', borderWidth: 2, tension: 0.4, fill: true, yAxisID: 'y' }, { label: 'P9 å¯¦å–® (å£)', data: [], borderColor: '#0a84ff', borderWidth: 2, tension: 0.4, borderDash: [5, 5], pointRadius: 0, fill: false, yAxisID: 'y1' } ] }, options: { ...commonOptions, scales: { x: { ticks: { color: '#666', maxTicksLimit: 6 }, grid: { display: false } }, y: { type: 'linear', display: true, position: 'left', grid: { color: '#222' }, ticks: { color: '#ff453a', callback: function(val){ return val + '%' } }, suggestedMin: -20, suggestedMax: 20 }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#0a84ff' } } } } });
    }
  </script>
</body>
</html>
